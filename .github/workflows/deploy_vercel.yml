name: Build and Deploy Flutter Web to Vercel

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # Use channel input for tracking the stable channel.
          # Optionally pin to a concrete SDK version for reproducible builds:
          # flutter-version: '3.13.0'
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Flutter web
        run: flutter build web --release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Use Node 20 to match modern CLI engine requirements
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          # Optional: add these two repository secrets so Vercel identifies the commit author
          # VERCEL_AUTHOR_NAME -> the display name of the Vercel user who owns the token
          # VERCEL_AUTHOR_EMAIL -> the email address of that Vercel user (must belong to a team member)
          VERCEL_AUTHOR_NAME: ${{ secrets.VERCEL_AUTHOR_NAME }}
          VERCEL_AUTHOR_EMAIL: ${{ secrets.VERCEL_AUTHOR_EMAIL }}
        run: |
          # Debug: show vercel CLI version and visible teams/projects for the token
          vercel --version || true
          echo "== whoami =="
          vercel whoami --token "$VERCEL_TOKEN" || true
          echo "== teams (visible) =="
          vercel teams ls --token "$VERCEL_TOKEN" || true
          echo "== projects (visible) =="
          vercel projects ls --token "$VERCEL_TOKEN" || true

          # Ensure Vercel sees a commit author that is allowed to deploy to the team.
          # Prefer explicit secrets VERCEL_AUTHOR_NAME / VERCEL_AUTHOR_EMAIL (set these in repo Secrets).
          # Fallback to the GitHub actor if secrets are not set (may still be rejected by Vercel).
          if [ -n "$VERCEL_AUTHOR_NAME" ]; then
            export VERCEL_GIT_COMMIT_AUTHOR_NAME="$VERCEL_AUTHOR_NAME"
          else
            export VERCEL_GIT_COMMIT_AUTHOR_NAME="$GITHUB_ACTOR"
          fi

          if [ -n "$VERCEL_AUTHOR_EMAIL" ]; then
            export VERCEL_GIT_COMMIT_AUTHOR_EMAIL="$VERCEL_AUTHOR_EMAIL"
          else
            export VERCEL_GIT_COMMIT_AUTHOR_EMAIL="$GITHUB_ACTOR@users.noreply.github.com"
          fi

          echo "Using commit author: $VERCEL_GIT_COMMIT_AUTHOR_NAME <$VERCEL_GIT_COMMIT_AUTHOR_EMAIL>"

          # Deploy the already-built static site by project name and scope (team slug).
          # Use --yes to accept prompts in CI (replaces deprecated --confirm).
          # Run from inside build/web so the CLI uploads the actual static files (avoids creating .vercel at repo root).
          echo "== build/web listing =="
          ls -la build/web || true
          echo "== index.html head (if present) =="
          head -n 30 build/web/index.html || true

          # If a vercel.json exists at repo root, copy it into build/web so the deployed static site uses the same config
          if [ -f vercel.json ]; then
            echo "Copying vercel.json into build/web so Vercel sees routing config"
            cp vercel.json build/web/
          fi

          pushd build/web
          vercel --token "$VERCEL_TOKEN" --yes --prod --debug --scope "apekkshaas-projects" || {
            echo "Vercel CLI failed with exit code $?"
            popd
            exit 1
          }
          popd
